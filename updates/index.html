<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Chat Box</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#2c2f33; color:#fff; display:flex; height:100vh; }
#users { width:220px; background:#23272a; padding:10px; overflow-y:auto; }
#users h3 { margin-top:0; text-align:center; font-size:1.2em; color:#fff; }
#user-list li { font-size:1.3em; margin-bottom:5px; }
#chat-container { flex:1; display:flex; flex-direction:column; position:relative; }
#messages { flex:1; overflow-y:scroll; padding:10px; display:flex; flex-direction:column; gap:12px; }
.message { padding:14px 20px; border-radius:12px; max-width:75%; word-wrap:break-word; transition:background 0.2s; position:relative; cursor:pointer; }
.message:hover { box-shadow:0 0 10px rgba(255,255,255,0.2); }
.message .username { font-size:1em; font-weight:bold; margin-right:5px; }
.message .text { font-size:1.5em; }
.message.right { background:#7289da; align-self:flex-end; }
.message.left { background:#333; align-self:flex-start; }
.message.highlighted { border:2px solid #ff6b6b; }
.message .avatar { width:24px; height:24px; border-radius:50%; background:#555; color:#fff; display:inline-flex; align-items:center; justify-content:center; margin-right:5px; font-weight:bold; font-size:1em; }
.message span.time { font-size:0.8em; color:#aaa; display:none; margin-left:5px; }
.message:hover span.time { display:inline; }
#input-container { display:flex; flex-direction:column; padding:10px; background:#23272a; }
#typing { font-size:1.3em; font-weight:bold; color:#ff6b6b; text-shadow:0 0 5px #fff; min-height:1.5em; margin-bottom:5px; }
#message-input { flex:1; padding:14px; border:none; border-radius:8px; font-size:1.3em; }
#send-btn { padding:14px 24px; border:none; border-radius:8px; margin-top:5px; background:#7289da; color:#fff; cursor:pointer; font-size:1.1em; }
#theme-toggle, #mute-toggle {
    position: fixed;
    bottom: 10px;
    padding: 8px 14px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background: #7289da;
    color: #fff;
    z-index: 1000;
}
#theme-toggle { left: 10px; }
#mute-toggle { left: 120px; }
</style>
</head>
<body>
<div id="users">
    <h3>Online Users</h3>
    <ul id="user-list"></ul>
</div>
<div id="chat-container">
    <div id="messages"></div>
    <div id="input-container">
        <div id="typing"></div>
        <input id="message-input" placeholder="Type your message..." autocomplete="off" />
        <button id="send-btn">Send</button>
    </div>
    <button id="theme-toggle">Toggle Theme</button>
    <button id="mute-toggle">ðŸ”Š</button>
</div>

<script>
const socket = io();

// Local username memory
let username = localStorage.getItem('chat-username');
while(!username) {
    username = prompt("Enter your username:");
    localStorage.setItem('chat-username', username);
}
socket.emit('set username', username);

const messagesDiv = document.getElementById('messages');
const input = document.getElementById('message-input');
const button = document.getElementById('send-btn');
const userList = document.getElementById('user-list');
const typingDiv = document.getElementById('typing');
const themeToggle = document.getElementById('theme-toggle');
const muteBtn = document.getElementById('mute-toggle');

let isMuted = false;
muteBtn.addEventListener('click', () => {
    isMuted = !isMuted;
    muteBtn.textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
});

let userColors = {};
function getColor(user) {
    if(userColors[user]) return userColors[user];
    const colors = ['#ff6b6b','#feca57','#48dbfb','#1dd1a1','#5f27cd','#ee5253','#ff9ff3','#54a0ff','#00d2d3','#c8d6e5'];
    const color = colors[Math.floor(Math.random()*colors.length)];
    userColors[user] = color;
    return color;
}

function playSound() {
    if(isMuted) return;
    const audio = new Audio('https://www.soundjay.com/button/sounds/button-3.mp3');
    audio.play();
}

function addMessage(msg) {
    const div = document.createElement('div');
    div.classList.add('message', msg.user === username ? 'right':'left');
    div.dataset.id = msg.id || '';
    div.dataset.user = msg.user;

    const avatar = document.createElement('span');
    avatar.classList.add('avatar');
    avatar.textContent = msg.user.charAt(0).toUpperCase();
    div.appendChild(avatar);

    const usernameSpan = document.createElement('span');
    usernameSpan.classList.add('username');
    usernameSpan.textContent = msg.user;
    usernameSpan.style.color = getColor(msg.user);
    div.appendChild(usernameSpan);

    const textSpan = document.createElement('span');
    textSpan.classList.add('text');
    textSpan.textContent = msg.text;
    div.appendChild(textSpan);

    const timeSpan = document.createElement('span');
    timeSpan.classList.add('time');
    timeSpan.textContent = msg.time;
    div.appendChild(timeSpan);

    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    if(msg.user !== username) playSound();
}

button.addEventListener('click', () => {
    const msg = input.value.trim();
    if(msg) {
        socket.emit('chat message', msg);
        input.value = '';
        socket.emit('typing', false);
    }
});

// Typing indicator
let typingTimeout;
input.addEventListener('input', () => {
    if(input.value.trim() !== '') {
        socket.emit('typing', true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => socket.emit('typing', false), 3000);
    } else {
        socket.emit('typing', false);
    }
});

themeToggle.addEventListener('click', () => {
    if(document.body.style.background === 'rgb(44, 47, 51)') {
        document.body.style.background = '#ffc0cb';
        document.body.style.color = '#000';
        document.querySelector('#users').style.background = '#ff7f9e';
        document.querySelectorAll('.username').forEach(u => u.style.color='#000');
    } else {
        document.body.style.background = '#2c2f33';
        document.body.style.color = '#fff';
        document.querySelector('#users').style.background = '#23272a';
        document.querySelectorAll('.username').forEach(u => u.style.color='');
    }
});

socket.on('chat message', addMessage);
socket.on('update users', users => {
    userList.innerHTML = '';
    users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u;
        userList.appendChild(li);
    });
});
socket.on('typing', usernames => {
    typingDiv.textContent = usernames ? `${usernames} is typing...` : '';
});

// System messages for join/leave
socket.on('system message', msg => {
    addMessage({user:'System', text:msg, time:''});
});
</script>
</body>
</html>
